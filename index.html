<!DOCTYPE html><html lang="en"><head><meta charset="utf-8">
<title>Human Resource Machine Program Viewer</title>
<link href='https://fonts.googleapis.com/css?family=Passion+One' rel='stylesheet' type='text/css'>
<style>
.footer {
	font-size: 80%;
	color: #888;
}
body {
	font-family: 'Passion One', sans-serif, Impact;
	font-size: 130%;
	background-color: #bca08b;
	color: black;
}
h1,h2,h3,h4 {
	font-weight: normal;
}
h1 {
	color: #9c8171;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	margin-left: 1em;
}
#code {
	border-collapse: collapse;
}
#code div {
	margin: .3em;
}
#code td {
	padding: 0.3em;
}
#code span {
	text-transform: lowercase;
	padding: 0.1em 0.5em;
	border-radius: 0.1em;
	box-shadow: 0.1em 0.1em 0.05em #ac907b;
}
.unknown {
}
.copyfrom,.copyto {
	background-color: #c96a52;
	color: #5f2b1d;
}
.comment {
	background-color: #ddd6b5;
	color: black;
}
.comment svg {
	vertical-align: middle;
}
.inbox,.outbox {
	background-color: #9cb65b;
	color: #474f2c;
}
.bumpup,.bumpdown,.add,.sub {
	background-color: #c48d63;
	color: #5b3d27;
}
.jump,.jumpn,.jumpz,.jumpdst {
	background-color: #8d8dc1;
	color: #3d3c5a;
}
.jumpdst {
	color: #5d5d91;
}
.asm_comment {
	background-color: #ddd6b5;
	color: #666;
}
td.linenum {
	background-color: #a48a78;
	color: #7b6456;
}
</style>
<script src="pako_inflate.min.js"></script>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>
<body>
<h1>Human Resource Machine Program Viewer</h1>


<table id="code">
</table>
<!-- <button onclick="mycode()">run</button> -->

<div class="footer">Human Resource Machine Program Viewer ©2015 Alan De Smet</div>

<script>

////////////////////////////////////////////////////////////////////////////////
function simple_svg(width, height) {
	var svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
	svg.setAttribute('version', '1.1');
	svg.setAttribute('baseProfile', 'full');
	svg.setAttribute('width', width);
	svg.setAttribute('height', height);
	svg.setAttribute('xmlns', "http://www.w3.org/2000/svg");
	this.svg = svg;

	this.new_el = function(name) {
		return document.createElementNS(this.svg.namespaceURI,name);
	}

	this.rect = function(x,y,width,height, color) {
		var e = this.new_el('rect');
		e.setAttribute('x',x);
		e.setAttribute('y',y);
		e.setAttribute('width',width);
		e.setAttribute('height',height);
		e.setAttribute('fill',color);
		this.svg.appendChild(e);
	}

	this.circle = function(x, y, radius, color) {
		var e = this.new_el('circle');
		e.setAttribute('cx',x);
		e.setAttribute('cy',y);
		e.setAttribute('r',radius);
		e.setAttribute('fill',color);
		this.svg.appendChild(e);
	}

	this.polyline = function(points, width, color) {
		var e = this.new_el('polyline');
		var pts = "";
		for(var i = 0; i < points.length; i++) {
			pts += points[i][0] + " " + points[i][1] + " ";
		}
		e.setAttribute('points', pts);
		e.setAttribute('stroke-linecap', 'round');
		e.setAttribute('stroke', color);
		e.setAttribute('fill', 'transparent');
		e.setAttribute('stroke-width', width);
		this.svg.appendChild(e);
	}
}

////////////////////////////////////////////////////////////////////////////////
function new_hrm_label_svg(width, height, enclabel) {

	var brush_width = Math.min(width,height)/10;
	//console.log("========",stri,"========");
	//console.log("base64:",enclabel.length, enclabel);
	var zlib = window.atob(enclabel);
	var zlibu8 = new Uint8Array(zlib.length);
	for(var i = 0; i < zlib.length; i++) {
		zlibu8[i] = zlib.charCodeAt(i);
	}
	//console.log("zlib:", zlib.length, zlib);
	
	/*
	var zlibu8_debug = "";
	for(var i = 0; i < zlibu8.length; i++) {
		zlibu8_debug += zlibu8[i] + " ";
	}
	console.log("zlib uint8", zlibu8.length, zlibu8_debug);
	*/
	var raw = pako.inflate(zlibu8);
	//console.log("raw", raw.length, raw);

	var new_svg = new simple_svg(width,height);
	new_svg.rect(0,0,width,height,'white');

	var dv = new DataView(raw.buffer);
	var elements = dv.getUint16(0, true);
	var points = [];
	for(var i = 0; i < elements && (i*4+6)<= raw.length; i++) {
		var index = i*4+4;
		var x = dv.getUint16(index, true);
		var y = dv.getUint16(index+2, true);
		if(x == 0 && y == 0) {
			if(points.length == 0) {
			} else if(points.length == 1) {
				new_svg.circle(points[0][0], points[0][1], brush_width, 'black');
			} else {
				new_svg.polyline(points, brush_width, 'black');
			}
			points = [];
		} else {
			x = rescale_label(x, 65535, width);
			y = rescale_label(y, 65535, height);
			points.push([x,y]);
		}
		//console.log(i,".",x,y);
	}
	//console.log("END");
	return new_svg.svg;
}

function rescale_label(x, oldmax, newmax) {
	return x * newmax / oldmax;
}

////////////////////////////////////////////////////////////////////////////////



var re_asm_comment = /^--/;
var re_jump_dst = /^(\S+):/;

function tokenize_line(line) {
	var match;

	line = line.replace(/^\s+/, '');
	line = line.replace(/\s+$/, '');

	if(line == "") { return [ 'blank' ]; }
	if(match = re_jump_dst.exec(line)) { return ['jumpdst', match[1]]; }
	if(re_asm_comment.test(line)) { return ['asm_comment', line]; }

	var tokens = line.split(/\s+/);

	var cmd = tokens[0].toLowerCase();

	var onearg = ['copyfrom', 'copyto', 'bumpup', 'bumpdown', 'jump', 'jumpn', 'jumpz', 'add', 'sub', 'comment'];
	var zeroarg = ['inbox', 'outbox'];

	if(tokens.length == 2) {
		for(var i = 0; i < onearg.length; i++) {
			if(cmd == onearg[i]) { return [cmd, tokens[1]]; }
		}
	} else if(tokens.length == 1) {
		for(var i = 0; i < zeroarg.length; i++) {
			if(cmd == zeroarg[i]) { return [cmd]; }
		}
	}

	return [ 'invalid', line ];
}

function is_code(cmd) {
	if(cmd == 'invalid' || cmd == 'blank' || cmd == 'jumpdst' || cmd == 'asm_comment' || cmd == 'comment') { return 0; }
	return 1;
}

function count_code_lines(lines) {
	var code_lines = 0;
	for(var i = 0; i < lines.length; i++) {
		var tokens = tokenize_line(lines[i]);
		if(is_code(tokens[0])) {
			code_lines++;
		}
	}
	return code_lines;
}

function extract_labels(ilines) {
	var out = {};
	out.olines = [];
	out.labels = {};
	out.labels['comment'] = {};
	out.labels['label'] = {};
	var re_define = /^DEFINE\s+(\S+)\s+(\S+)/i;
	for(var i = 0; i < ilines.length; i++) {
		var thisline = ilines[i];
		//console.log(i,thisline);
		if(match = re_define.exec(thisline)) {
			//console.log('hit');
			var body = '';
			var more = 1;
			while(more) {
				i++;
				var line = ilines[i];
				line = line.replace(/^\s+/, '');
				line = line.replace(/\s+$/, '');
				if(/;$/.test(line)) {
					line = line.replace(/;$/, '');
					more = 0;
				}
				body += line;
				if(i >= ilines.length) { more = 0; }
			}
			var mytype = match[1].toLowerCase();
			out.labels[mytype][match[2]] = body;
			//console.log(mytype,">"+match[2]+"->",body);
		} else {
			//console.log('miss');
			out.olines.push(thisline);
		}
	}

	return out;
}

function append_code_table(root, lines) {
	
	if(lines[0] == "-- HUMAN RESOURCE MACHINE PROGRAM --") { lines.shift(); }

	var labels = extract_labels(lines);
	lines = labels.olines;

	var num_len = 2;
	var pad = "00000";
	// TODO: This is the wrong way to count lines; many aren't.
	var code_lines = count_code_lines(lines);
	if(code_lines.length > 9999) { num_len = 5; }
	else if(code_lines.length > 999) { num_len = 4; }
	else if(code_lines.length > 99) { num_len = 3; } 
	var line_number = 0;
	for(var i = 0; i < lines.length; i++) {
		var tokens = tokenize_line(lines[i]);
		if(tokens[0] == 'blank') { continue; }
		var newclass = tokens[0];
		var iscode = is_code(tokens[0]);

		var text = newclass;
		if(text == 'bumpup') { text = 'bump +'; }
		else if(text == 'bumpdown') { text = 'bump −'; }
		else if(text == 'asm_comment') {
			text = tokens[1];
			tokens = [];
		} else if(text == 'jumpdst') {
			text = tokens[1];
			tokens = [];
		}
		
		var comment_id;
		if(text == 'comment') {
			comment_id = tokens[1];
			if(comment_id in labels.labels['comment']) {
				text = '';
				tokens = [];
			}
		}

		var e_cmd = $(document.createElement('span'));
		e_cmd.text(text);
		e_cmd.addClass(newclass);
		e_cmd.addClass('cmd');

		if(newclass == "comment") {
			var svg = new_hrm_label_svg(70, 20, labels.labels['comment'][comment_id]);
			svg = $(svg);
			e_cmd.append(svg);
		}

		var e_arg = 0;
		if(tokens.length == 2) {
			e_arg = $(document.createElement('span'));
			e_arg.text(tokens[1]);
			e_arg.addClass(newclass);
			e_arg.addClass('arg');
		}

		var new_td_num = $(document.createElement('td'));
		if(iscode) {
			line_number++;
			var linenum = (pad+line_number).slice(-num_len);
			new_td_num.text(linenum);
		}
		new_td_num.addClass('linenum');

		var new_td_code = $(document.createElement('td'));
		new_td_code.append(e_cmd);
		//console.log(tokens[0]);
		if(e_arg) {
			new_td_code.append($(document.createTextNode(' ')));
			new_td_code.append(e_arg);
			//console.log("   "+tokens[1]);
		}

		var new_row = $(document.createElement('tr'));
		new_row.append(new_td_num);
		new_row.append(new_td_code);
		root.append(new_row);
	}
}

function code_arrived(data) {
	console.log("Code downloaded.\n");

	//console.log(this.responseText);
	//var lines = this.responseText.split(new RegExp('\r?\n'));
	var root = $('#code');
	var lines = data.split(new RegExp('\r?\n'));
	append_code_table(root, lines)

}
var code = "tests/36-Alphabetizer.size.speed.asm";

// TODO: Why logging a syntax error? I'm specifying text.
$.get(code, code_arrived, "text")

//var codereq = new XMLHttpRequest();
//codereq.overrideMimeType('text/plain');
//codereq.addEventListener("load", code_arrived);
////codereq.addEventListener("error", function(){console.log("error")});
////codereq.addEventListener("abort", function(){console.log("abort")});
////codereq.addEventListener("progress", function(o){console.log("progress", o.loaded, o.total)});
//console.log("Getting", code);
//codereq.open("GET", code);
//codereq.send()
//console.log("Request out");
</script>
</body>
</html>
