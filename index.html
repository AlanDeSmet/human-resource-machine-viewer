<!DOCTYPE html><html lang="en"><head><meta charset="utf-8">
<title>Human Resource Machine Program Viewer</title>
<link href='https://fonts.googleapis.com/css?family=Passion+One' rel='stylesheet' type='text/css'>
<style>
body {
	font-family: 'Passion One', sans-serif, Impact;
	font-size: 130%;
	background-color: #bca08b;
	color: black;
}
h1,h2,h3,h4 {
	font-weight: normal;
}
h1 {
	color: #9c8171;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	margin-left: 1em;
}
#code {
	border-collapse: collapse;
}
#code div {
	margin: .3em;
}
#code td {
	padding: 0.3em;
}
#code span {
	text-transform: lowercase;
	padding: 0.1em 0.5em;
	border-radius: 0.1em;
	box-shadow: 0.1em 0.1em 0.05em #ac907b;
}
.unknown {
}
.copyfrom,.copyto {
	background-color: #c96a52;
	color: #5f2b1d;
}
.comment {
	background-color: #ddd6b5;
	color: black;
}
.inbox,.outbox {
	background-color: #9cb65b;
	color: #474f2c;
}
.bumpup,.bumpdown,.add,.sub {
	background-color: #c48d63;
	color: #5b3d27;
}
.jump,.jumpn,.jumpz,.jumpdst {
	background-color: #8d8dc1;
	color: #3d3c5a;
}
.jumpdst {
	color: #5d5d91;
}
.asm_comment {
	background-color: #ddd6b5;
	color: #666;
}
td.linenum {
	background-color: #a48a78;
	color: #7b6456;
}
</style>
<script src="https://code.jquery.com/jquery-2.1.4.min.js"></script>
</head>
<body>
<h1>Human Resource Machine Program Viewer</h1>


<table id="code">
</table>
<!-- <button onclick="mycode()">run</button> -->

<div class="footer">©2015 Alan De Smet</div>

<script>
var re_asm_comment = /^--/;
var re_jump_dst = /^(\S+):/;

function tokenize_line(line) {
	var match;

	line = line.replace(/^\s+/, '');
	line = line.replace(/\s+$/, '');

	if(line == "") { return [ 'blank' ]; }
	if(match = re_jump_dst.exec(line)) { return ['jumpdst', match[1]]; }
	if(re_asm_comment.test(line)) { return ['asm_comment', line]; }

	var tokens = line.split(/\s+/);

	var cmd = tokens[0].toLowerCase();

	var onearg = ['copyfrom', 'copyto', 'bumpup', 'bumpdown', 'jump', 'jumpn', 'jumpz', 'add', 'sub', 'comment'];
	var zeroarg = ['inbox', 'outbox'];

	if(tokens.length == 2) {
		for(var i = 0; i < onearg.length; i++) {
			if(cmd == onearg[i]) { return [cmd, tokens[1]]; }
		}
	} else if(tokens.length == 1) {
		for(var i = 0; i < zeroarg.length; i++) {
			if(cmd == zeroarg[i]) { return [cmd]; }
		}
	}

	return [ 'invalid', line ];
}

function is_code(cmd) {
	if(cmd == 'blank' || cmd == 'jumpdst' || cmd == 'asm_comment' || cmd == 'comment') { return 0; }
	return 1;
}

function count_code_lines(lines) {
	var code_lines = 0;
	for(var i = 0; i < lines.length; i++) {
		var tokens = tokenize_line(lines[i]);
		if(is_code(tokens[0])) {
			code_lines++;
		}
	}
	return code_lines;
}

function code_arrived(data) {
	console.log("Done");

	//console.log(this.responseText);
	//var lines = this.responseText.split(new RegExp('\r?\n'));
	var lines = data.split(new RegExp('\r?\n'));
	var root = $('#code');
	var num_len = 2;
	var pad = "00000";
	// TODO: This is the wrong way to count lines; many aren't.
	var code_lines = count_code_lines(lines);
	if(code_lines.length > 9999) { num_len = 5; }
	else if(code_lines.length > 999) { num_len = 4; }
	else if(code_lines.length > 99) { num_len = 3; } 
	var line_number = 0;
	for(var i = 0; i < lines.length; i++) {
		var tokens = tokenize_line(lines[i]);
		if(tokens[0] == 'blank') { continue; }
		var newclass = tokens[0];
		var iscode = is_code(tokens[0]);

		var text = newclass;
		if(text == 'bumpup') { text = 'bump +'; }
		else if(text == 'bumpdown') { text = 'bump −'; }
		else if(text == 'asm_comment') {
			text = tokens[1];
			tokens = [];
		} else if(text == 'jumpdst') {
			text = tokens[1];
			tokens = [];
		}

		var e_cmd = $(document.createElement('span'));
		e_cmd.text(text);
		e_cmd.addClass(newclass);
		e_cmd.addClass('cmd');

		var e_arg = 0;
		if(tokens.length == 2) {
			e_arg = $(document.createElement('span'));
			e_arg.text(tokens[1]);
			e_arg.addClass(newclass);
			e_arg.addClass('arg');
		}

		var new_td_num = $(document.createElement('td'));
		if(iscode) {
			line_number++;
			var linenum = (pad+line_number).slice(-num_len);
			new_td_num.text(linenum);
		}
		new_td_num.addClass('linenum');

		var new_td_code = $(document.createElement('td'));
		new_td_code.append(e_cmd);
		console.log(tokens[0]);
		if(e_arg) {
			new_td_code.append($(document.createTextNode(' ')));
			new_td_code.append(e_arg);
			console.log("   "+tokens[1]);
		}

		var new_row = $(document.createElement('tr'));
		new_row.append(new_td_num);
		new_row.append(new_td_code);
		root.append(new_row);
	}

}
var code = "tests/36-Alphabetizer.size.speed.asm";

// TODO: Why logging a syntax error? I'm specifying text.
$.get(code, code_arrived, "text")

//var codereq = new XMLHttpRequest();
//codereq.overrideMimeType('text/plain');
//codereq.addEventListener("load", code_arrived);
////codereq.addEventListener("error", function(){console.log("error")});
////codereq.addEventListener("abort", function(){console.log("abort")});
////codereq.addEventListener("progress", function(o){console.log("progress", o.loaded, o.total)});
//console.log("Getting", code);
//codereq.open("GET", code);
//codereq.send()
//console.log("Request out");
</script>
</body>
</html>
